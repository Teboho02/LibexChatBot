<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <title>Libex AI Assistant</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="main.css">

</head>

<body>

    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <img src="./public/libexlogo.png" alt="Libex Logo" class="chatbot-logo">
                <h2 class="header-text">Ask anything about Libex</h2>

            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-content">
                        Hello! I'm the Libex AI Assistant. Ask me anything about Libex and I'll help you.
                    </div>
                    <div class="message-time"></div>
                </div>
            </div>
            
            <div class="chat-input">
                <input type="text" class="input-field" id="questionInput" placeholder="Type your question here..." autofocus>
                <button class="send-btn" id="sendButton">Ask
                </button>
            </div>
        </div>
    </div>
    


    <script>
        const questionInput = document.getElementById('questionInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');
        let messages = [];

        
        let isProcessing = false;
        
        // Add initial greeting message with timestamp
        const initialMessage = document.querySelector('.bot-message .message-time');
    //    initialMessage.textContent = formatTime(new Date());
        
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function savePreviousMessges(){

            /*schema
            {
                "messages": [
                    {
                        "content": "Hello! I'm the Libex AI Assistant. Ask me anything about Libex and I'll help you.",
                        "isUser": false
                    },
                    {
                        "content": "What is Libex?",
                        "isUser": true
                    },
                    {
                        "content": "Libex is a platform that helps you to create and manage your own library.",
                        "isUser": false
                    }
                ]
            }

            */

            let messageDivs = document.querySelectorAll('.message');
            messageDivs.forEach(messageDiv => {
                let messageContent = messageDiv.querySelector('.message-content').textContent;
                let isUser = messageDiv.classList.contains('user-message');
                messages.push({ content: messageContent, isUser });
            });

            localStorage.setItem('libex-messages', JSON.stringify({ messages }));



        }
        
        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'typing-indicator';
            loadingDiv.id = 'loadingIndicator';
            
            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'typing-dots';
            
            // Add three dots for the typing animation
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                dotsDiv.appendChild(dot);
            }
            
            loadingDiv.appendChild(dotsDiv);
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            

            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            savePreviousMessges();
            
            return messageDiv;
        }
        

    
        
        async function sendQuestion() {
            if (isProcessing) return;
            
            const question = questionInput.value.trim();
            if (!question) return;
            
            // Add user message
            addMessage(question, true);
            
            questionInput.value = '';
            

            
            // Set processing flag
            isProcessing = true;
            sendButton.disabled = true;
            
            // Show loading indicator
            showLoadingIndicator();
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question , messages})
                });
                

                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                
                hideLoadingIndicator();
                
                addMessage(data.answer || "Sorry, I couldn't process your request.");
                
            } catch (error) {
                console.error('Error:', error);
                
                hideLoadingIndicator();
                
                addMessage("I'm sorry, I'm having trouble connecting right now. Please try again later.");
            } finally {
                isProcessing = false;
                sendButton.disabled = false;
                questionInput.focus();
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendQuestion);
        
        questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestion();
            }
        });
        
        // Focus input on load
        window.addEventListener('load', () => {
            questionInput.focus();
        });
    </script>
</body>
</html>